<!DOCTYPE html []>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="author" content="MarkdownViewer++" />
    <title>php-testing.md</title>
    <style type="text/css">
            
/* Avoid page breaks inside the most common attributes, especially for exports (i.e. PDF) */
td, h1, h2, h3, h4, h5, p, ul, ol, li {
    page-break-inside: avoid; 
}

        </style>
  </head>
  <body>
    <h1 id="testing-your-codebase-for-the-php7-migration">Testing Your Codebase for the PHP7 Migration</h1>
    <h3 id="published-on-may-9-2017">Published on May 9, 2017</h3>
    <p>We are preparing to upgrade the Departmental Web Hosting Environment to PHP 7.0 within the next month.  Knowing that there are at least a few backwards incompatible changes between PHP 5.X and 7.0, the thought of combing through tens of thousands of lines of code is enough to cause a panic attack.  Thankfully, it doesn't have to be a horrifying process.  There are several tools that can be used to assist you in pinpointing areas that might have issues under PHP7.  In addition, you can use these tools <strong>today</strong> to start evaluating your code; you don't have to wait until PHP7 is available on the -dev servers.</p>
    <p>
      <em>It should be noted that all of these tools can be run on your local machine. If you're on a Mac, you can probably follow the directions here and be up and running.  If you're on a PC, you'll need to either have php installed and running, or bring up a virtual machine that has php installed.</em>
    </p>
    <h2>PHP7CC</h2>
First is <a href="https://github.com/sstalle/php7cc">PHP 7 Compatibility Checker </a>(major hat-tip to Matt Stanley for letting me know about this package).  The easiest way to use it in our environment is with the phar version of php7cc.  After you've logged into your account (via ssh), navigate to somewhere above your web root.  The php7cc.phar is a single file, so if you want you can place it into the directory immediately above your www directory.  Next, use wget to retrieve php7cc.phar from github
<p>[bash]</p><p>wget <a href="https://github.com/sstalle/php7cc/releases/download/1.1.0/php7cc.phar">https://github.com/sstalle/php7cc/releases/download/1.1.0/php7cc.phar</a></p><p>[/bash]</p><p>wget should download the file and report that it successfully saved php7cc.phar.  Now we're ready to have it test our codebase.  Using it is pretty straightforward: execute it giving it the path to the code you want to have checked.  As an example, if I have php7cc.phar saved in the directory above my www directory and i want it to scan the code in one of my WordPress plugins, I can do</p><p>[bash]php php7cc.phar www/wp-content/plugins/mizzoumvc/[/bash]</p><p>It should then generate a report identifying all <em>possible</em> compatibility issues.  In the report it will list the file, line number and the potential issue.
<code></code></p><p>[php]
File: /var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc/library/Main.php
-&gt; Line 127: Possible array element creation during by-reference assignment
$this-&gt;aryRenderData['MainPost'] =&amp; $this-&gt;aryRenderData['objMainPost'];
-&gt; Line 141: Possible array element creation during by-reference assignment
$this-&gt;aryRenderData['Site'] =&amp; $aryContext['objSite'];
-&gt; Line 302: Function argument(s) returned by "func_get_args" might have been modified
func_get_args();
[/php]</p><p> </p><p class="p3">It is very possible that it will generate false-positives, so you will need to dig into the code to verify the issues it identified.  If you don't want to read the report in the terminal screen, you can have it save it to a file.</p><code></code><p>[bash]
php php7cc.phar www/wp-content/plugins/mizzoumvc/ &gt; php7cc-report.txt
[/bash]</p><p> </p><p class="p3">Alternatively, there is a <a href="https://hub.docker.com/r/ypereirareis/php7cc/">docker container for php7cc</a> you can use if you'd prefer to test locally and either don't want to install php7cc locally or don't have php installed.</p><h2 class="p3">PHP 7 Migration Assistant Report (MAR)</h2><p class="p3">Next up is the <a href="https://github.com/Alexia/php7mar">PHP7 Migration Assistant Report</a>.  There is no phar available, so you'll need to either clone the repository, or download the zip archive from github and then extract the contents. For running on our environment, from the directory above my www, I'll clone the repository</p><p>[bash]git clone <a href="https://github.com/Alexia/php7mar.git%5B/bash%5D">https://github.com/Alexia/php7mar.git[/bash]</a></p><p class="p3">This will clone the repository's contents into a <em>php7mar</em> directory.  Move into that directory.  To have it begin the analysis, do</p><p>[bash]php mar.php -f="/var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc"[/bash]</p><p class="p3">Once finished, php7mar will indicate that is saved a report. By default, it generates a markdown-based report (named by date) into a reports directory.</p><p>[php]
2017-05-08T20:59:30+00:00
Scanning /var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc
Including file extensions: php
ERROR! Syntax checking was selected and a PHP binary lower than 7.0.0-dev was specified.
Processed 28055 lines contained in 310 files.
Processing took 33.93580698967 seconds.</p><h1 id="critical">critical</h1><h4 id="varwwwhtmlfoo.missouri.eduwwwwp-contentpluginsmizzoumvchelperscourse-grabberdepartmentcourseinfowsobject.php">/var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc/helpers/course-grabber/DepartmentCourseInfoWSObject.php</h4><ul><li>deprecatedFunctions</li><li>Line 58: <code>//return mysql_real_escape_string($item);</code></li></ul><h1 id="nuance">nuance</h1><h4 id="varwwwhtmlfoo.missouri.eduwwwwp-contentpluginsmizzoumvchelperstwigtwiglibtwigcompiler.php">/var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc/helpers/twig/twig/lib/Twig/Compiler.php</h4><ul><li>funcGetArg</li><li>Line 108: <code>$strings = func_get_args();</code></li></ul><h4 id="varwwwhtmlfoo.missouri.eduwwwwp-contentpluginsmizzoumvchelperstwigtwiglibtwigextensiondebug.php">/var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc/helpers/twig/twig/lib/Twig/Extension/Debug.php</h4><ul><li>funcGetArg</li><li>Line 59: <code>var_dump(func_get_arg($i));</code></li></ul><h4 id="varwwwhtmlfoo.missouri.eduwwwwp-contentpluginsmizzoumvclibraryloader.php">/var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc/library/Loader.php</h4><ul><li>funcGetArg</li><li>Line 41: <code>//_mizzou_log(func_get_args(),'all the args passed to constructor',false,array('line'=&amp;amp;amp;amp;amp;gt;__LINE__,'file'=&amp;amp;amp;amp;amp;gt;__FILE__));</code></li></ul><h4 id="varwwwhtmlfoo.missouri.eduwwwwp-contentpluginsmizzoumvclibrarymain.php">/var/www/html/foo.missouri.edu/www/wp-content/plugins/mizzoumvc/library/Main.php</h4><ul><li>funcGetArg</li><li>Line 265: <code>$aryArgs = func_get_args();</code>
[/php]</li></ul><p> </p><p><em>*<strong>note</strong> - php7mar does support an -r option that allows you to identify a different location to save the report.</em></p><p>You'll notice that php7mar's report picked up issues that are commented out in the source code, and also picked up a few issues that php7cc did not.  In addition, it did not flag some possible issues that php7cc identified.  This is why it's always good to run a couple of different tests on your source code.</p><h2>PHPCodeSniffer+PHPCompatibility</h2>
It's entirely possible that your IDE already has <a href="https://github.com/squizlabs/PHP_CodeSniffer">PHPCodeSniffer</a> with the <a href="https://github.com/wimg/PHPCompatibility">PHPCompatibility</a> standard installed.  You'll need to check your IDE's documentation to see if it comes with CodeSniffer, or if you can add it in as a plugin/module. In PHPStorm, you can access it by right-clicking on the project, Inspect Code, Inspection Profile, click the ellipsis button. From there, scroll down to PHP --&gt; Probable Bugs, and make sure PHP 7 Compatibility is checked.
<p>If you decide to download CodeSniffer directly, please note that CodeSniffer 3.0 (released this week) introduced breaking changes and PHPCompatibility has not yet been updated.  You'll need to make sure you download the 2.9 branch.  I plan on doing a follow-up guide on installing and using PHPCodeSniffer+PHPCompatibility tomorrow.</p><h2>Fixing the Code</h2>
Now the fun part begins: checking the identified areas and making corrections.  Using my examples from above, the error "Possible array element creation during by-reference assignment" refers to the backwards incompatible change "<a href="http://php.net/manual/en/migration70.incompatible.php#migration70.incompatible.variable-handling.list.string">Array ordering when elements are automatically created during by reference assignments has changed.</a>" In the case of my example code, the order of the array elements does not matter, and will not affect the expected behavior once we move to PHP7.  The error "Function argument(s) returned by 'func_get_args' might have been modified" refers to the backwards incompatibility "<a href="http://php.net/manual/en/migration70.incompatible.php#migration70.incompatible.other.func-parameters">Functions inspecting arguments report the current parameter value</a>."  This one I'll definitely need to double-check and make sure I'm not affecting the parameter values before calling func_get_args().
<p>Of course everyone's code is going to be different, and I'm positive you'll come across different notices.  If you run into some you don't understand, or are having a hard time figuring out <strong>reach out to the campus web dev community</strong>! We're here to help each other.  If you don't feel comfortable asking the group-at-large, reach out to me directly.  We want this migration to be as smooth and as transparent as possible to all of our end-users, and will do whatever we can to make that happen.</p></body>
</html>
